<%- include ../header -%>

  <h1>Dashboard</h1>
  <h2>Info</h2>
  Your token: <b><%= user.token %></b><br/>
  Email: <%= user.email %> <br/>
  <h2>API Calls</h2>
  This month calls: <a href="/calls"><%= user.monthly_calls_count %></a><br/>
  Expected bill: <a href="/bills">$<%= user.monthly_bill() %></a><br/>
  <% if (user.card.token) { %>
  Card number: ****<%= user.card.last_digits %>
  <% }  %>
  <h2>Update Payment</h2>

  <form id="payment-form" onsubmit="return onUpdateCard(this);" action="card" method="POST" >
    <div class="form-row">
      <label>
        <span>Card Number</span>
        <input type="text" name="number" size="20" data-stripe="number"/>
      </label>
    </div>

    <div class="form-row">
      <label>
        <span>Expiration (MM/YY)</span>
        <input type="text" name="month" size="2" data-stripe="exp-month"/>
      </label>
      <span> / </span>
      <input type="text" name="year" size="2" data-stripe="exp-year"/>
    </div>

    <div class="form-row">
      <label>
        <span>CVC</span>
        <input type="text" name="cvc" size="4" data-stripe="cvc"/>
      </label>
    </div>

    <input type="hidden" name="token" id="token" />
    <button type="submit">Update Payment</button>
  </form>
  <p id="error" style="color:red;"></p>
  <a href="/logout">logout</a>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <script type="text/javascript">

    function onUpdateCard(form){
      Stripe.setPublishableKey('pk_test_QNbEPeTckhQCMGiR0HkYZR8x');
      if ($("#token").val() == ""){
        Stripe.card.createToken(form, stripeResponseHandler);
        return false;
      }
    }

    function stripeResponseHandler(status, response) {
      console.log(status, response);
      if (status == 200){
        $("#error").text("");
        $("#token").val(response.id);
        $("#payment-form").submit();
        return true;
      } else {
        $("#error").text(response.error.message);
      }
    };
  </script>


<%- include ../footer -%>